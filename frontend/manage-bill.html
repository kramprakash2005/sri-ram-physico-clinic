<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Bill - Sri Ram Physico Clinic</title>
    <!-- CSS Links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans:wght@400;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="d-flex">
        <!-- Side Navigation Bar -->
        <nav class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door-fill"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="patients.html"><i class="bi bi-people-fill"></i> Patients</a></li>
                <li class="nav-item"><a class="nav-link" href="visits.html"><i class="bi bi-person-walking"></i> Visits</a></li>
                <li class="nav-item"><a class="nav-link active" href="billing.html"><i class="bi bi-receipt"></i> Billing</a></li>
                <li class="nav-item"><a class="nav-link" href="services.html"><i class="bi bi-gear-fill"></i> Services</a></li>
                <li class="nav-item"><a class="nav-link" href="reports.html"><i class="bi bi-bar-chart-line-fill"></i> Reports</a></li>
            </ul>
        </nav>

        <!-- Main Content Wrapper -->
        <div class="main-content-wrapper">
            <!-- Top Bar -->
            <header class="top-bar d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-heart-pulse-fill logo-icon me-2"></i>
                    <h5 class="clinic-logo-text mb-0">Sri Ram Physico Clinic</h5>
                </div>
                <button class="btn btn-outline-secondary"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </header>

            <!-- Main Content Area -->
            <main class="content-area p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0" id="manage-bill-title">Loading Bill...</h4>
                    <a href="billing.html" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to All Bills</a>
                </div>

                <div class="row g-4">
                    <!-- Left Column: Bill Details -->
                    <div class="col-lg-7">
                        <div class="dashboard-card p-4">
                            <h5>Bill for: <span id="patient-name" class="text-primary">...</span></h5>
                            <p id="visit-date" class="text-muted">Visit Date: ...</p>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Treatments</h6>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addTreatmentModal">
                                    <i class="bi bi-plus-lg"></i> Add Treatment
                                </button>
                            </div>
                            <ul id="treatments-list" class="list-group mb-4">
                                <!-- Treatments will be added here -->
                            </ul>
                            
                            <div>
                                <label for="medicalRemark" class="form-label">Medical Remark</label>
                                <textarea class="form-control" id="medicalRemark" rows="3" placeholder="Add any clinical notes here..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Payment Summary -->
                    <div class="col-lg-5">
                        <div class="dashboard-card p-4">
                            <h6 class="text-muted">Total Amount</h6>
                            <h2 id="total-amount" class="stat-number mb-4">â‚¹ 0</h2>

                            <h6 class="text-muted">Payment Status</h6>
                            <p><span id="payment-status" class="badge fs-6"></span></p>

                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethod">
                                    <option value="">Choose...</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI</option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button id="mark-as-paid-btn" class="btn btn-success btn-lg">Mark as Paid & Save</button>
                                <button class="btn btn-outline-secondary"><i class="bi bi-printer"></i> Print Bill</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for Adding a Treatment -->
    <div class="modal fade" id="addTreatmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Treatment to Bill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="treatmentSelect" class="form-label">Select a service</label>
                    <select class="form-select" id="treatmentSelect">
                        <!-- Options will be loaded here -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="add-to-bill-btn" class="btn btn-primary">Add to Bill</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Internal JavaScript for Manage Bill Page -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Element References
            const billTitle = document.getElementById('manage-bill-title');
            const patientNameEl = document.getElementById('patient-name');
            const visitDateEl = document.getElementById('visit-date');
            const treatmentsListEl = document.getElementById('treatments-list');
            const totalAmountEl = document.getElementById('total-amount');
            const paymentStatusEl = document.getElementById('payment-status');
            const medicalRemarkEl = document.getElementById('medicalRemark');
            const paymentMethodEl = document.getElementById('paymentMethod');
            const markAsPaidBtn = document.getElementById('mark-as-paid-btn');
            const treatmentSelectEl = document.getElementById('treatmentSelect');
            const addToBillBtn = document.getElementById('add-to-bill-btn');

            // API URLs
            const billingApiUrl = 'http://127.0.0.1:8000/billing';
            const servicesApiUrl = 'http://127.0.0.1:8000/services';

            // State
            let currentBill = null;
            let allServices = [];

            // Get Bill ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const billId = urlParams.get('id');

            if (!billId) {
                alert('No bill ID found.');
                window.location.href = './billing.html';
                return;
            }

            // --- DATA FETCHING FUNCTIONS ---
            async function fetchBillDetails() {
                try {
                    const response = await fetch(`${billingApiUrl}/${billId}`);
                    if (!response.ok) throw new Error('Bill not found.');
                    currentBill = await response.json();
                    renderBillDetails();
                } catch (error) {
                    console.error(error);
                    alert('Could not load bill details.');
                }
            }

            async function fetchAllServices() {
                try {
                    const response = await fetch(servicesApiUrl);
                    if (!response.ok) throw new Error('Could not fetch services.');
                    allServices = await response.json();
                    renderServiceOptions();
                } catch (error) {
                    console.error(error);
                }
            }
            
            // --- UI RENDERING FUNCTIONS ---
            function renderBillDetails() {
                billTitle.textContent = `Manage Bill: ${currentBill.bill_id}`;
                patientNameEl.textContent = currentBill.patient.fullName;
                visitDateEl.textContent = `Visit Date: ${new Date(currentBill.visit.entryDate).toLocaleDateString('en-CA')}`;
                medicalRemarkEl.value = currentBill.medicalRemark || '';
                paymentMethodEl.value = currentBill.paymentMethod || '';
                updatePaymentStatusUI(currentBill.paymentStatus);
                renderTreatments();
            }

            function renderServiceOptions() {
                treatmentSelectEl.innerHTML = '<option selected disabled value="">Choose a treatment...</option>';
                allServices.forEach(service => {
                    const option = `<option value="${service._id}">${service.name} (â‚¹ ${service.cost})</option>`;
                    treatmentSelectEl.insertAdjacentHTML('beforeend', option);
                });
            }

            function renderTreatments() {
                treatmentsListEl.innerHTML = '';
                if (currentBill.treatments.length === 0) {
                    treatmentsListEl.innerHTML = '<li class="list-group-item text-muted">No treatments added yet.</li>';
                }
                currentBill.treatments.forEach((treatment, index) => {
                    const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${treatment.name}
                        <span>â‚¹ ${treatment.cost}</span>
                    </li>`;
                    treatmentsListEl.insertAdjacentHTML('beforeend', item);
                });
                updateTotalAmount();
            }
            
            function updateTotalAmount() {
                const total = currentBill.treatments.reduce((sum, t) => sum + t.cost, 0);
                currentBill.totalAmount = total;
                totalAmountEl.textContent = `â‚¹ ${total.toFixed(2)}`;
            }

            function updatePaymentStatusUI(status) {
                paymentStatusEl.textContent = status;
                if (status === 'Paid') {
                    paymentStatusEl.className = 'badge bg-success-subtle text-success-emphasis fs-6';
                    markAsPaidBtn.disabled = true;
                    markAsPaidBtn.textContent = 'Payment Completed';
                } else {
                    paymentStatusEl.className = 'badge bg-danger-subtle text-danger-emphasis fs-6';
                    markAsPaidBtn.disabled = false;
                    markAsPaidBtn.textContent = 'Mark as Paid & Save';
                }
            }

            // --- EVENT LISTENERS ---
            addToBillBtn.addEventListener('click', () => {
                const selectedServiceId = treatmentSelectEl.value;
                if (!selectedServiceId) return;

                const serviceToAdd = allServices.find(s => s._id === selectedServiceId);
                if (serviceToAdd) {
                    currentBill.treatments.push({
                        treatment_id: serviceToAdd._id,
                        name: serviceToAdd.name,
                        cost: serviceToAdd.cost
                    });
                    renderTreatments();
                    bootstrap.Modal.getInstance(document.getElementById('addTreatmentModal')).hide();
                }
            });

            markAsPaidBtn.addEventListener('click', async () => {
                if (!paymentMethodEl.value) {
                    alert('Please select a payment method.');
                    return;
                }

                const updateData = {
                    treatments: currentBill.treatments,
                    totalAmount: currentBill.totalAmount,
                    paymentStatus: 'Paid',
                    paymentMethod: paymentMethodEl.value,
                    medicalRemark: medicalRemarkEl.value
                };

                try {
                    const response = await fetch(`${billingApiUrl}/${billId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    if (!response.ok) throw new Error('Failed to update bill.');
                    
                    currentBill = await response.json();
                    renderBillDetails(); // Re-render with final data
                    alert('Bill has been marked as paid and saved successfully!');

                } catch (error) {
                    console.error(error);
                    alert('Could not save the bill.');
                }
            });

            // --- INITIAL LOAD ---
            fetchBillDetails();
            fetchAllServices();
        });
    </script>
</body>
</html>
